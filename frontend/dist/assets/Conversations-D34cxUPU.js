import{_ as R}from"./_plugin-vue_export-helper-DRcqrMy4.js";/* empty css                   *//* empty css                *//* empty css                 *//* empty css                  *//* empty css               *//* empty css                  *//* empty css                     */import{a4 as y,d as F,r as u,o as P,x as M,c as U,e as n,g as k,w as p,a8 as q,f as a,ah as T,ai as G,k as h,l as N,P as f,O as C,af as J,t as r,au as K,T as Q,j as t,az as V,ad as W,s as X,aA as Y,ax as Z,aB as B}from"./index-Bf3lHhEM.js";import{u as ee}from"./account-B7d52lTG.js";const x={list:i=>y.get("/conversations",{params:{accountId:i}}).then(o=>o.data),getMessages:(i,o,c=50,_=0)=>y.get(`/conversations/${o}/messages`,{params:{accountId:i,limit:c,offset:_}}).then(d=>d.data),markAsRead:(i,o)=>y.post(`/conversations/${o}/read`,null,{params:{accountId:i}}).then(c=>c.data)},se={class:"conversations-page"},ae={class:"card-header"},te={class:"conv-container"},oe={class:"conv-list"},ne=["onClick"],le={class:"conv-info"},ce={class:"conv-header"},re={class:"conv-name"},ie={class:"conv-time"},de={class:"conv-last"},ue={class:"last-msg"},me={class:"message-area"},_e={class:"message-header"},ve={class:"message-list"},pe={class:"message-content"},he={class:"message-text"},fe={class:"message-time"},ge=F({__name:"Conversations",setup(i){const o=ee(),c=u([]),_=u([]),d=u(!1),g=u(!1),m=u(""),v=u(null);P(async()=>{await o.fetchAccounts(),o.accounts.length>0&&(m.value=o.accounts[0].id,A())});async function A(){if(m.value){d.value=!0;try{const s=await x.list(m.value);c.value=s.conversations||[]}catch{M.error("获取会话列表失败")}finally{d.value=!1}}}async function b(s){v.value=s,g.value=!0;try{const l=await x.getMessages(s.accountId,s.chatId);_.value=(l.messages||[]).reverse(),s.unread>0&&(await x.markAsRead(s.accountId,s.chatId),s.unread=0)}catch{M.error("获取消息失败")}finally{g.value=!1}}function D(s){return B(s).format("MM-DD HH:mm")}function H(s){return B(s).format("HH:mm")}const S=U(()=>[...c.value].sort((s,l)=>l.lastTime-s.lastTime));return(s,l)=>{const z=Z,L=K,$=W,j=Y,E=J,O=q,I=G;return t(),n("div",se,[k(O,{class:"conv-card"},{header:p(()=>[a("div",ae,[l[1]||(l[1]=a("span",{class:"title"},"会话管理",-1)),k(L,{modelValue:m.value,"onUpdate:modelValue":l[0]||(l[0]=e=>m.value=e),placeholder:"选择账号",style:{width:"200px"},onChange:A},{default:p(()=>[(t(!0),n(f,null,C(Q(o).accounts,e=>(t(),h(z,{key:e.id,label:e.nickname||e.id,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),default:p(()=>[a("div",te,[T((t(),n("div",oe,[(t(!0),n(f,null,C(S.value,e=>{var w;return t(),n("div",{key:e.chatId,class:V(["conv-item",{active:((w=v.value)==null?void 0:w.chatId)===e.chatId}]),onClick:ye=>b(e)},[k($,{size:40,src:e.userAvatar},{default:p(()=>[X(r(e.userName[0]),1)]),_:2},1032,["src"]),a("div",le,[a("div",ce,[a("span",re,r(e.userName),1),a("span",ie,r(D(e.lastTime)),1)]),a("div",de,[a("span",ue,r(e.lastMessage),1),e.unread>0?(t(),h(j,{key:0,value:e.unread,class:"unread-badge"},null,8,["value"])):N("",!0)])])],10,ne)}),128)),!d.value&&c.value.length===0?(t(),h(E,{key:0,description:"暂无会话"})):N("",!0)])),[[I,d.value]]),T((t(),n("div",me,[v.value?(t(),n(f,{key:0},[a("div",_e,[a("span",null,r(v.value.userName),1)]),a("div",ve,[(t(!0),n(f,null,C(_.value,e=>(t(),n("div",{key:e.id,class:V(["message-item",{"message-out":e.direction==="out"}])},[a("div",pe,[a("div",he,r(e.content),1),a("div",fe,r(H(e.msgTime)),1)])],2))),128))])],64)):(t(),h(E,{key:1,description:"选择一个会话查看消息"}))])),[[I,g.value]])])]),_:1})])}}}),Ve=R(ge,[["__scopeId","data-v-8cea68c3"]]);export{Ve as default};
