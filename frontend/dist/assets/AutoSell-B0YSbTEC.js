import{_ as ye}from"./_plugin-vue_export-helper-DRcqrMy4.js";/* empty css                   */import{w as ke}from"./el-divider-DDNGmvp4.js";/* empty css                     *//* empty css                  *//* empty css                   *//* empty css                     *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                 *//* empty css                *//* empty css                 *//* empty css                        */import"./el-tooltip-l0sNRNKZ.js";/* empty css                        *//* empty css                  *//* empty css                  */import{a4 as k,d as be,r as v,o as he,x as p,e as r,g as t,w as n,a8 as Ve,ag as we,ah as Ce,k as h,l as w,ai as Ie,ac as Se,f as m,ak as xe,t as b,ae as Ee,s as f,az as Te,aC as Re,aj as $e,q as Ue,T as D,aD as Me,H as Oe,ao as De,ab as Ae,af as je,ap as ze,aq as Be,E as Le,m as Ne,n as qe,au as Fe,P as A,O as j,ax as Ge,aF as Pe,aG as We,ar as K,j as o}from"./index-Bf3lHhEM.js";import{g as He}from"./goods-Bcbnfspn.js";const C={listRules:()=>k.get("/autosell").then(d=>d.data),getRule:d=>k.get(`/autosell/${d}`).then(u=>u.data),createRule:d=>k.post("/autosell",d).then(u=>u.data),updateRule:(d,u)=>k.put(`/autosell/${d}`,u).then(g=>g.data),deleteRule:d=>k.delete(`/autosell/${d}`).then(u=>u.data),setRuleEnabled:(d,u)=>k.patch(`/autosell/${d}/enabled`,{enabled:u}).then(g=>g.data),getStock:d=>k.get(`/autosell/${d}/stock`).then(u=>u.data),addStock:(d,u)=>k.post(`/autosell/${d}/stock`,{content:u}).then(g=>g.data),clearStock:d=>k.delete(`/autosell/${d}/stock`).then(u=>u.data),getLogs:(d=50,u=0)=>k.get("/autosell/logs",{params:{limit:d,offset:u}}).then(g=>g.data)},Je={class:"autosell-page"},Ke={class:"card-header"},Qe={class:"actions"},Xe={class:"goods-title"},Ye={key:1,class:"text-muted"},Ze={key:0,class:"sku-info"},el={key:1,class:"text-muted"},ll={key:1,class:"text-muted"},tl={key:1},al={class:"goods-option"},nl=["src"],ol={class:"goods-info"},sl={class:"goods-name"},ul={class:"goods-price"},il={key:0},dl={key:0,class:"stock-stats"},rl=be({__name:"AutoSell",setup(d){const u=v([]),g=v([]),L=v([]),R=v(!1),I=v(!1),z=v(!1),_=v(null),S=v(""),N=v(!1),x=v(null),s=v({name:"",deliveryType:"fixed",deliveryContent:"",triggerOn:"paid",shippingMode:"virtual",autoRefund:!1,itemIds:[],skuInfos:[],workflowId:void 0}),$=v(""),F=[{value:"fixed",label:"固定内容"},{value:"stock",label:"库存发货"},{value:"api",label:"API 接口"}],G=[{value:"paid",label:"付款后"},{value:"confirmed",label:"确认收货后"}],P=[{value:"virtual",label:"虚拟发货"},{value:"freeshipping",label:"免拼发货"}];he(()=>{V(),Q(),X()});async function V(){R.value=!0;try{const a=await C.listRules();u.value=a.rules||[]}catch{p.error("获取规则列表失败")}finally{R.value=!1}}async function Q(){try{const a=await ke.list();g.value=(a.workflows||[]).filter(l=>l.enabled)}catch{console.error("获取工作流列表失败")}}async function X(){try{const a=await He.list();L.value=a.items||[]}catch{console.error("获取商品列表失败")}}function Y(){x.value=null,s.value={name:"",deliveryType:"fixed",deliveryContent:"",triggerOn:"paid",shippingMode:"virtual",autoRefund:!1,itemIds:[],skuInfos:[],workflowId:void 0},$.value="",I.value=!0}function Z(a){x.value=a.id,s.value={name:a.name,deliveryType:a.deliveryType,deliveryContent:a.deliveryContent||"",triggerOn:a.triggerOn,shippingMode:a.shippingMode||"virtual",autoRefund:a.autoRefund||!1,itemIds:a.itemIds||[],skuInfos:a.skuInfos||[],workflowId:a.workflowId||void 0},$.value=(a.skuInfos||[]).join(`
`),I.value=!0}async function ee(){if(!s.value.name){p.warning("请填写规则名称");return}const a=$.value.split(`
`).map(l=>l.trim()).filter(l=>l.length>0);s.value.skuInfos=a,N.value=!0;try{x.value?(await C.updateRule(x.value,s.value),p.success("更新成功")):(await C.createRule(s.value),p.success("创建成功")),I.value=!1,V()}catch{p.error(x.value?"更新失败":"创建失败")}finally{N.value=!1}}async function le(a){try{await C.setRuleEnabled(a.id,!a.enabled),p.success(a.enabled?"已禁用":"已启用"),V()}catch{p.error("操作失败")}}async function te(a){try{await K.confirm(`确定删除规则 "${a.name}"？`,"确认删除",{type:"warning"}),await C.deleteRule(a.id),p.success("删除成功"),V()}catch(l){l!=="cancel"&&p.error("删除失败")}}function ae(a){_.value=a,S.value="",z.value=!0}async function ne(){if(!S.value.trim()||!_.value){p.warning("请输入库存内容");return}try{const a=await C.addStock(_.value.id,S.value);p.success(`成功添加 ${a.count} 条库存`),S.value="",V()}catch{p.error("添加失败")}}async function oe(){if(_.value)try{await K.confirm("确定清空所有库存？","确认清空",{type:"warning"}),await C.clearStock(_.value.id),p.success("已清空"),V()}catch(a){a!=="cancel"&&p.error("清空失败")}}function se(a){var l;return((l=F.find(i=>i.value===a))==null?void 0:l.label)||a}function ue(a){var l;return((l=G.find(i=>i.value===a))==null?void 0:l.label)||a}function ie(a){var l;return((l=P.find(i=>i.value===a))==null?void 0:l.label)||a}function de(a){if(!a||a.length===0)return"全部商品";const l=a.map(i=>{const c=L.value.find(E=>E.id===i);return c?c.title:i});return l.length<=2?l.join(", "):`${l[0]} 等 ${l.length} 个商品`}function re(a){if(!a)return"默认流程";const l=g.value.find(i=>i.id===a);return l?l.name:`工作流 #${a}`}function pe(a){return!a||a.length===0?"":a.length<=2?a.join(", "):`${a[0]} 等 ${a.length} 个规格`}return(a,l)=>{const i=Ue,c=Se,E=xe,U=Ee,W=Re,ce=$e,fe=Ae,ve=je,me=Ve,B=qe,y=Ne,T=Ge,M=Fe,H=Le,J=we,q=Pe,ge=We,_e=Ie;return o(),r("div",Je,[t(me,null,{header:n(()=>[m("div",Ke,[l[16]||(l[16]=m("span",{class:"title"},"自动发货规则",-1)),m("div",Qe,[t(i,{icon:D(ze),onClick:V,loading:R.value},{default:n(()=>[...l[14]||(l[14]=[f("刷新",-1)])]),_:1},8,["icon","loading"]),t(i,{type:"primary",icon:D(Be),onClick:Y},{default:n(()=>[...l[15]||(l[15]=[f("添加规则",-1)])]),_:1},8,["icon"])])])]),default:n(()=>[Ce((o(),h(fe,{data:u.value,stripe:""},{default:n(()=>[t(c,{label:"规则名称",prop:"name","min-width":"120"}),t(c,{label:"绑定商品","min-width":"150"},{default:n(({row:e})=>[m("div",null,[e.itemIds&&e.itemIds.length>0?(o(),h(E,{key:0,content:e.itemIds.join(", "),placement:"top"},{default:n(()=>[m("span",Xe,b(de(e.itemIds)),1)]),_:2},1032,["content"])):(o(),r("span",Ye,"全部商品"))]),e.skuInfos&&e.skuInfos.length>0?(o(),r("div",Ze,[t(E,{content:e.skuInfos.join(", "),placement:"top"},{default:n(()=>[t(U,{size:"small",type:"info"},{default:n(()=>[f(b(pe(e.skuInfos)),1)]),_:2},1024)]),_:2},1032,["content"])])):w("",!0)]),_:1}),t(c,{label:"工作流",width:"120"},{default:n(({row:e})=>[e.workflowId?(o(),h(U,{key:0,size:"small",type:"success"},{default:n(()=>[f(b(re(e.workflowId)),1)]),_:2},1024)):(o(),r("span",el,"默认"))]),_:1}),t(c,{label:"发货类型",width:"100"},{default:n(({row:e})=>[t(U,{size:"small"},{default:n(()=>[f(b(se(e.deliveryType)),1)]),_:2},1024)]),_:1}),t(c,{label:"发货方式",width:"100"},{default:n(({row:e})=>[t(U,{size:"small",type:e.shippingMode==="freeshipping"?"success":"info"},{default:n(()=>[f(b(ie(e.shippingMode||"virtual")),1)]),_:2},1032,["type"])]),_:1}),t(c,{label:"触发时机",width:"100"},{default:n(({row:e})=>[f(b(ue(e.triggerOn)),1)]),_:1}),t(c,{label:"自动退款",width:"90",align:"center"},{default:n(({row:e})=>[e.autoRefund?(o(),h(U,{key:0,size:"small",type:"warning"},{default:n(()=>[...l[17]||(l[17]=[f("开启",-1)])]),_:1})):(o(),r("span",ll,"-"))]),_:1}),t(c,{label:"库存",width:"100"},{default:n(({row:e})=>[e.deliveryType==="stock"&&e.stockStats?(o(),r("span",{key:0,class:Te({"text-danger":e.stockStats.available===0})},b(e.stockStats.available)+" / "+b(e.stockStats.total),3)):(o(),r("span",tl,"-"))]),_:1}),t(c,{label:"状态",width:"70",align:"center"},{default:n(({row:e})=>[t(W,{modelValue:e.enabled,"onUpdate:modelValue":O=>e.enabled=O,onChange:O=>le(e)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(c,{label:"操作",width:"130",align:"center"},{default:n(({row:e})=>[t(ce,null,{default:n(()=>[t(E,{content:"编辑"},{default:n(()=>[t(i,{icon:D(Me),onClick:O=>Z(e)},null,8,["icon","onClick"])]),_:2},1024),e.deliveryType==="stock"?(o(),h(E,{key:0,content:"管理库存"},{default:n(()=>[t(i,{icon:D(Oe),onClick:O=>ae(e)},null,8,["icon","onClick"])]),_:2},1024)):w("",!0),t(i,{icon:D(De),type:"danger",onClick:O=>te(e)},null,8,["icon","onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[_e,R.value]]),!R.value&&u.value.length===0?(o(),h(ve,{key:0,description:"暂无规则"})):w("",!0)]),_:1}),t(J,{modelValue:I.value,"onUpdate:modelValue":l[10]||(l[10]=e=>I.value=e),title:x.value?"编辑规则":"添加规则",width:"600px"},{footer:n(()=>[t(i,{onClick:l[9]||(l[9]=e=>I.value=!1)},{default:n(()=>[...l[21]||(l[21]=[f("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:ee,loading:N.value},{default:n(()=>[...l[22]||(l[22]=[f("确定",-1)])]),_:1},8,["loading"])]),default:n(()=>[t(H,{"label-width":"100px"},{default:n(()=>[t(y,{label:"规则名称",required:""},{default:n(()=>[t(B,{modelValue:s.value.name,"onUpdate:modelValue":l[0]||(l[0]=e=>s.value.name=e),placeholder:"请输入规则名称"},null,8,["modelValue"])]),_:1}),t(y,{label:"绑定商品"},{default:n(()=>[t(M,{modelValue:s.value.itemIds,"onUpdate:modelValue":l[1]||(l[1]=e=>s.value.itemIds=e),style:{width:"100%"},multiple:"",clearable:"",filterable:"",placeholder:"不选择则匹配全部商品"},{default:n(()=>[(o(!0),r(A,null,j(L.value,e=>(o(),h(T,{key:e.id,value:e.id,label:e.title},{default:n(()=>[m("div",al,[e.picUrl?(o(),r("img",{key:0,src:e.picUrl,class:"goods-pic"},null,8,nl)):w("",!0),m("div",ol,[m("div",sl,b(e.title),1),m("div",ul,"¥"+b(e.price),1)])])]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(y,{label:"规格匹配"},{default:n(()=>[t(B,{modelValue:$.value,"onUpdate:modelValue":l[2]||(l[2]=e=>$.value=e),type:"textarea",rows:2,placeholder:`每行一个规格，如：大小:1个
不填则匹配所有规格`},null,8,["modelValue"]),l[18]||(l[18]=m("div",{class:"form-tip"},'从订单详情中获取的规格信息，如"大小:1个"、"颜色:红色"等',-1))]),_:1}),t(y,{label:"工作流"},{default:n(()=>[t(M,{modelValue:s.value.workflowId,"onUpdate:modelValue":l[3]||(l[3]=e=>s.value.workflowId=e),style:{width:"100%"},clearable:"",placeholder:"不选择则使用默认流程"},{default:n(()=>[t(T,{value:0,label:"默认流程"}),(o(!0),r(A,null,j(g.value,e=>(o(),h(T,{key:e.id,value:e.id,label:e.name},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(y,{label:"发货类型",required:""},{default:n(()=>[t(M,{modelValue:s.value.deliveryType,"onUpdate:modelValue":l[4]||(l[4]=e=>s.value.deliveryType=e),style:{width:"100%"}},{default:n(()=>[(o(),r(A,null,j(F,e=>t(T,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),s.value.deliveryType==="fixed"?(o(),h(y,{key:0,label:"发货内容"},{default:n(()=>[t(B,{modelValue:s.value.deliveryContent,"onUpdate:modelValue":l[5]||(l[5]=e=>s.value.deliveryContent=e),type:"textarea",rows:4,placeholder:"请输入发货内容"},null,8,["modelValue"])]),_:1})):w("",!0),t(y,{label:"触发时机"},{default:n(()=>[t(M,{modelValue:s.value.triggerOn,"onUpdate:modelValue":l[6]||(l[6]=e=>s.value.triggerOn=e),style:{width:"100%"}},{default:n(()=>[(o(),r(A,null,j(G,e=>t(T,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(y,{label:"发货方式"},{default:n(()=>[t(M,{modelValue:s.value.shippingMode,"onUpdate:modelValue":l[7]||(l[7]=e=>s.value.shippingMode=e),style:{width:"100%"}},{default:n(()=>[(o(),r(A,null,j(P,e=>t(T,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),l[19]||(l[19]=m("div",{class:"form-tip"},"虚拟发货：直接确认发货；免拼发货：调用免拼发货接口",-1))]),_:1}),t(y,{label:"自动退款"},{default:n(()=>[t(W,{modelValue:s.value.autoRefund,"onUpdate:modelValue":l[8]||(l[8]=e=>s.value.autoRefund=e)},null,8,["modelValue"]),l[20]||(l[20]=m("span",{class:"form-tip",style:{"margin-left":"12px"}},"开启后，未发货订单申请退款时自动同意",-1))]),_:1})]),_:1})]),_:1},8,["modelValue","title"]),t(J,{modelValue:z.value,"onUpdate:modelValue":l[13]||(l[13]=e=>z.value=e),title:"管理库存",width:"600px"},{footer:n(()=>[t(i,{type:"danger",onClick:oe},{default:n(()=>[...l[23]||(l[23]=[f("清空库存",-1)])]),_:1}),t(i,{onClick:l[12]||(l[12]=e=>z.value=!1)},{default:n(()=>[...l[24]||(l[24]=[f("关闭",-1)])]),_:1}),t(i,{type:"primary",onClick:ne},{default:n(()=>[...l[25]||(l[25]=[f("添加",-1)])]),_:1})]),default:n(()=>[_.value?(o(),r("div",il,[_.value.stockStats?(o(),r("div",dl,[t(q,{title:"总数",value:_.value.stockStats.total},null,8,["value"]),t(q,{title:"已用",value:_.value.stockStats.used},null,8,["value"]),t(q,{title:"可用",value:_.value.stockStats.available},null,8,["value"])])):w("",!0),t(ge),t(H,{"label-width":"80px"},{default:n(()=>[t(y,{label:"添加库存"},{default:n(()=>[t(B,{modelValue:S.value,"onUpdate:modelValue":l[11]||(l[11]=e=>S.value=e),type:"textarea",rows:6,placeholder:"每行一条库存内容"},null,8,["modelValue"])]),_:1})]),_:1})])):w("",!0)]),_:1},8,["modelValue"])])}}}),$l=ye(rl,[["__scopeId","data-v-4711ce6a"]]);export{$l as default};
