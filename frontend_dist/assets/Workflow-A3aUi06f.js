import{_ as ke}from"./_plugin-vue_export-helper-DRcqrMy4.js";/* empty css                   *//* empty css                 *//* empty css                        *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                  *//* empty css                   *//* empty css                     */import{w as x}from"./el-divider-DDNGmvp4.js";/* empty css               *//* empty css                *//* empty css                 *//* empty css                        */import"./el-tooltip-l0sNRNKZ.js";/* empty css                        *//* empty css                  *//* empty css                  */import{d as we,r as g,c as Ne,o as Ce,x as d,e as y,g as t,w as a,a8 as Ee,ag as Me,ah as De,k as V,l as k,ai as xe,ac as Ue,f as p,s as m,Y as Oe,T as c,aH as W,t as U,aC as Se,aj as Ie,ak as he,q as Je,aI as Te,aD as G,aJ as Ye,ao as H,ab as Xe,af as $e,ap as Be,aq as K,E as je,a6 as Le,a7 as ze,m as qe,n as Re,aG as Ae,aK as Fe,ae as We,au as Ge,P as w,O as T,aE as He,ar as Ke,j as f,ax as Pe}from"./index-Bf3lHhEM.js";const Qe={class:"workflow-page"},Ze={class:"card-header"},el={class:"actions"},ll={class:"workflow-name"},tl={class:"template-buttons"},al={class:"nodes-list"},ol={class:"config-preview"},nl={class:"node-type-desc"},il=we({__name:"Workflow",setup(ul){const Y=g([]),O=g(!1),N=g(!1),S=g(null),X=g(!1),C=g(!1),E=g(-1),i=g({name:"",description:"",definition:{nodes:[],connections:[]},isDefault:!1}),n=g({id:"",type:"trigger",name:"",config:{},posX:0,posY:0}),B=[{value:"trigger",label:"触发节点",description:"流程开始节点"},{value:"autoreply",label:"自动回复",description:"发送消息并等待用户回复"},{value:"delivery",label:"发货节点",description:"执行发货操作"},{value:"ship",label:"标记发货",description:"标记订单为已发货"},{value:"delay",label:"延迟节点",description:"等待一段时间后继续"},{value:"condition",label:"条件节点",description:"根据条件分支"},{value:"notify",label:"通知节点",description:"发送通知消息"}],P=[{value:"virtual",label:"虚拟发货"},{value:"freeshipping",label:"免拼发货"}],Q=[{value:"fixed",label:"固定延迟"},{value:"random",label:"随机延迟"}],Z=[{value:"exact",label:"精确匹配"},{value:"contains",label:"包含匹配"}],j=Ne({get:()=>{var o;return((o=n.value.config.keywords)==null?void 0:o.join(","))||""},set:o=>{n.value.config.keywords=o?o.split(",").map(e=>e.trim()).filter(Boolean):[]}});Ce(()=>{M()});async function M(){O.value=!0;try{const o=await x.list();Y.value=o.workflows||[]}catch{d.error("获取工作流列表失败")}finally{O.value=!1}}function ee(){S.value=null,i.value={name:"",description:"",definition:{nodes:[{id:"trigger",type:"trigger",name:"触发",config:{},posX:100,posY:200}],connections:[]},isDefault:!1},N.value=!0}function le(o){S.value=o,i.value={name:o.name,description:o.description||"",definition:JSON.parse(JSON.stringify(o.definition)),isDefault:o.isDefault},N.value=!0}async function te(){if(!i.value.name){d.warning("请填写工作流名称");return}X.value=!0;try{S.value?(await x.update(S.value.id,i.value),d.success("更新成功")):(await x.create(i.value),d.success("创建成功")),N.value=!1,M()}catch{d.error("操作失败")}finally{X.value=!1}}async function ae(o){try{await x.update(o.id,{enabled:!o.enabled}),d.success(o.enabled?"已禁用":"已启用"),M()}catch{d.error("操作失败")}}async function oe(o){if(!o.isDefault)try{await x.setDefault(o.id),d.success("已设为默认"),M()}catch{d.error("设置失败")}}async function ne(o){if(o.isDefault){d.warning("默认工作流不能删除");return}try{await Ke.confirm(`确定删除工作流 "${o.name}"？`,"确认删除",{type:"warning"}),await x.delete(o.id),d.success("删除成功"),M()}catch(e){e!=="cancel"&&d.error("删除失败")}}function ie(){E.value=-1;const o=`node_${Date.now()}`;n.value={id:o,type:"delivery",name:"",config:{},posX:100+i.value.definition.nodes.length*250,posY:200},C.value=!0}function ue(o){E.value=o;const e=i.value.definition.nodes[o];n.value=JSON.parse(JSON.stringify(e)),C.value=!0}function de(o){const e=i.value.definition.nodes[o];if(e.type==="trigger"){d.warning("触发节点不能删除");return}i.value.definition.nodes.splice(o,1),i.value.definition.connections=i.value.definition.connections.filter(u=>u.fromNode!==e.id&&u.toNode!==e.id)}function se(){if(!n.value.name){d.warning("请填写节点名称");return}if(E.value>=0)i.value.definition.nodes[E.value]=JSON.parse(JSON.stringify(n.value));else{i.value.definition.nodes.push(JSON.parse(JSON.stringify(n.value)));const o=i.value.definition.nodes;if(o.length>1){const e=o[o.length-2];i.value.definition.connections.push({fromNode:e.id,fromOutput:"output_1",toNode:n.value.id,toInput:"input_1"})}}C.value=!1}function re(o){var e;return((e=B.find(u=>u.value===o))==null?void 0:e.label)||o}function pe(o){const e=JSON.stringify(o.definition,null,2),u=new Blob([e],{type:"application/json"}),_=URL.createObjectURL(u),s=document.createElement("a");s.href=_,s.download=`workflow_${o.name}.json`,s.click(),URL.revokeObjectURL(_)}function fe(){const o=document.createElement("input");o.type="file",o.accept=".json",o.onchange=async e=>{var _;const u=(_=e.target.files)==null?void 0:_[0];if(u)try{const s=await u.text(),D=JSON.parse(s);if(!D.nodes||!D.connections)throw new Error("Invalid workflow definition");i.value.definition=D,d.success("导入成功")}catch{d.error("导入失败，请检查文件格式")}},o.click()}function me(){i.value.definition={nodes:[{id:"trigger",type:"trigger",name:"触发",config:{},posX:100,posY:200},{id:"delivery",type:"delivery",name:"发货",config:{deliveryMode:"virtual"},posX:350,posY:200},{id:"ship",type:"ship",name:"标记发货",config:{},posX:600,posY:200}],connections:[{fromNode:"trigger",fromOutput:"output_1",toNode:"delivery",toInput:"input_1"},{fromNode:"delivery",fromOutput:"output_1",toNode:"ship",toInput:"input_1"}]},d.success("已应用默认模板")}function ce(){i.value.definition={nodes:[{id:"trigger",type:"trigger",name:"触发",config:{},posX:100,posY:200},{id:"autoreply",type:"autoreply",name:"确认发货",config:{promptMessage:'您好，订单已准备好，请回复"确认"开始发货',keywords:["确认","好的","可以"],matchMode:"contains"},posX:350,posY:200},{id:"delivery",type:"delivery",name:"发货",config:{deliveryMode:"virtual"},posX:600,posY:200},{id:"ship",type:"ship",name:"标记发货",config:{},posX:850,posY:200}],connections:[{fromNode:"trigger",fromOutput:"output_1",toNode:"autoreply",toInput:"input_1"},{fromNode:"autoreply",fromOutput:"output_1",toNode:"delivery",toInput:"input_1"},{fromNode:"delivery",fromOutput:"output_1",toNode:"ship",toInput:"input_1"}]},d.success("已应用确认发货模板")}return(o,e)=>{const u=Je,_=Oe,s=Ue,D=Se,I=he,L=Ie,z=Xe,ve=$e,ge=Ee,b=Re,r=qe,q=ze,ye=Le,_e=Ae,be=We,R=je,A=Me,h=Pe,J=Ge,$=He,Ve=xe;return f(),y("div",Qe,[t(ge,null,{header:a(()=>[p("div",Ze,[e[21]||(e[21]=p("span",{class:"title"},"工作流管理",-1)),p("div",el,[t(u,{icon:c(Be),onClick:M,loading:O.value},{default:a(()=>[...e[19]||(e[19]=[m("刷新",-1)])]),_:1},8,["icon","loading"]),t(u,{type:"primary",icon:c(K),onClick:ee},{default:a(()=>[...e[20]||(e[20]=[m("添加工作流",-1)])]),_:1},8,["icon"])])])]),default:a(()=>[De((f(),V(z,{data:Y.value,stripe:""},{default:a(()=>[t(s,{label:"名称",prop:"name","min-width":"150"},{default:a(({row:l})=>[p("div",ll,[l.isDefault?(f(),V(_,{key:0,class:"default-icon"},{default:a(()=>[t(c(W))]),_:1})):k("",!0),m(" "+U(l.name),1)])]),_:1}),t(s,{label:"描述",prop:"description","min-width":"200","show-overflow-tooltip":""}),t(s,{label:"节点数",width:"100",align:"center"},{default:a(({row:l})=>{var v,F;return[m(U(((F=(v=l.definition)==null?void 0:v.nodes)==null?void 0:F.length)||0),1)]}),_:1}),t(s,{label:"状态",width:"80",align:"center"},{default:a(({row:l})=>[t(D,{modelValue:l.enabled,"onUpdate:modelValue":v=>l.enabled=v,onChange:v=>ae(l)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(s,{label:"操作",width:"220",align:"center"},{default:a(({row:l})=>[t(L,null,{default:a(()=>[t(I,{content:"设为默认"},{default:a(()=>[t(u,{icon:l.isDefault?c(W):c(Te),type:l.isDefault?"warning":"default",onClick:v=>oe(l)},null,8,["icon","type","onClick"])]),_:2},1024),t(I,{content:"编辑"},{default:a(()=>[t(u,{icon:c(G),onClick:v=>le(l)},null,8,["icon","onClick"])]),_:2},1024),t(I,{content:"导出"},{default:a(()=>[t(u,{icon:c(Ye),onClick:v=>pe(l)},null,8,["icon","onClick"])]),_:2},1024),t(I,{content:"删除"},{default:a(()=>[t(u,{icon:c(H),type:"danger",onClick:v=>ne(l),disabled:l.isDefault},null,8,["icon","onClick","disabled"])]),_:2},1024)]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Ve,O.value]]),!O.value&&Y.value.length===0?(f(),V(ve,{key:0,description:"暂无工作流"})):k("",!0)]),_:1}),t(A,{modelValue:N.value,"onUpdate:modelValue":e[4]||(e[4]=l=>N.value=l),title:S.value?"编辑工作流":"添加工作流",width:"900px"},{footer:a(()=>[t(u,{onClick:e[3]||(e[3]=l=>N.value=!1)},{default:a(()=>[...e[27]||(e[27]=[m("取消",-1)])]),_:1}),t(u,{type:"primary",onClick:te,loading:X.value},{default:a(()=>[...e[28]||(e[28]=[m("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[t(R,{"label-width":"100px"},{default:a(()=>[t(ye,{gutter:20},{default:a(()=>[t(q,{span:12},{default:a(()=>[t(r,{label:"名称",required:""},{default:a(()=>[t(b,{modelValue:i.value.name,"onUpdate:modelValue":e[0]||(e[0]=l=>i.value.name=l),placeholder:"请输入工作流名称"},null,8,["modelValue"])]),_:1})]),_:1}),t(q,{span:12},{default:a(()=>[t(r,{label:"设为默认"},{default:a(()=>[t(D,{modelValue:i.value.isDefault,"onUpdate:modelValue":e[1]||(e[1]=l=>i.value.isDefault=l)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(r,{label:"描述"},{default:a(()=>[t(b,{modelValue:i.value.description,"onUpdate:modelValue":e[2]||(e[2]=l=>i.value.description=l),type:"textarea",rows:2,placeholder:"请输入描述"},null,8,["modelValue"])]),_:1}),t(_e,{"content-position":"left"},{default:a(()=>[...e[22]||(e[22]=[m("流程节点",-1)])]),_:1}),p("div",tl,[t(u,{size:"small",onClick:me},{default:a(()=>[...e[23]||(e[23]=[m("默认模板（直接发货）",-1)])]),_:1}),t(u,{size:"small",onClick:ce},{default:a(()=>[...e[24]||(e[24]=[m("确认模板（等待确认后发货）",-1)])]),_:1}),t(u,{size:"small",icon:c(Fe),onClick:fe},{default:a(()=>[...e[25]||(e[25]=[m("导入",-1)])]),_:1},8,["icon"])]),p("div",al,[t(z,{data:i.value.definition.nodes,size:"small"},{default:a(()=>[t(s,{label:"节点ID",prop:"id",width:"120"}),t(s,{label:"类型",width:"100"},{default:a(({row:l})=>[t(be,{size:"small"},{default:a(()=>[m(U(re(l.type)),1)]),_:2},1024)]),_:1}),t(s,{label:"名称",prop:"name"}),t(s,{label:"配置","min-width":"200"},{default:a(({row:l})=>[p("span",ol,U(JSON.stringify(l.config)),1)]),_:1}),t(s,{label:"操作",width:"100",align:"center"},{default:a(({$index:l})=>[t(L,{size:"small"},{default:a(()=>[t(u,{icon:c(G),onClick:v=>ue(l)},null,8,["icon","onClick"]),t(u,{icon:c(H),type:"danger",onClick:v=>de(l),disabled:i.value.definition.nodes[l].type==="trigger"},null,8,["icon","onClick","disabled"])]),_:2},1024)]),_:1})]),_:1},8,["data"]),t(u,{class:"add-node-btn",icon:c(K),onClick:ie},{default:a(()=>[...e[26]||(e[26]=[m("添加节点",-1)])]),_:1},8,["icon"])])]),_:1})]),_:1},8,["modelValue","title"]),t(A,{modelValue:C.value,"onUpdate:modelValue":e[18]||(e[18]=l=>C.value=l),title:E.value>=0?"编辑节点":"添加节点",width:"600px"},{footer:a(()=>[t(u,{onClick:e[17]||(e[17]=l=>C.value=!1)},{default:a(()=>[...e[34]||(e[34]=[m("取消",-1)])]),_:1}),t(u,{type:"primary",onClick:se},{default:a(()=>[...e[35]||(e[35]=[m("确定",-1)])]),_:1})]),default:a(()=>[t(R,{"label-width":"100px"},{default:a(()=>[t(r,{label:"节点类型",required:""},{default:a(()=>[t(J,{modelValue:n.value.type,"onUpdate:modelValue":e[5]||(e[5]=l=>n.value.type=l),style:{width:"100%"},disabled:E.value>=0&&n.value.type==="trigger"},{default:a(()=>[(f(),y(w,null,T(B,l=>t(h,{key:l.value,label:l.label,value:l.value},{default:a(()=>[p("div",null,[p("span",null,U(l.label),1),p("span",nl,U(l.description),1)])]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue","disabled"])]),_:1}),t(r,{label:"节点名称",required:""},{default:a(()=>[t(b,{modelValue:n.value.name,"onUpdate:modelValue":e[6]||(e[6]=l=>n.value.name=l),placeholder:"请输入节点名称"},null,8,["modelValue"])]),_:1}),n.value.type==="delivery"?(f(),V(r,{key:0,label:"发货方式"},{default:a(()=>[t(J,{modelValue:n.value.config.deliveryMode,"onUpdate:modelValue":e[7]||(e[7]=l=>n.value.config.deliveryMode=l),style:{width:"100%"}},{default:a(()=>[(f(),y(w,null,T(P,l=>t(h,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})):k("",!0),n.value.type==="autoreply"?(f(),y(w,{key:1},[t(r,{label:"提示消息"},{default:a(()=>[t(b,{modelValue:n.value.config.promptMessage,"onUpdate:modelValue":e[8]||(e[8]=l=>n.value.config.promptMessage=l),type:"textarea",rows:2,placeholder:"发送给用户的提示消息"},null,8,["modelValue"])]),_:1}),t(r,{label:"期望关键词"},{default:a(()=>[t(b,{modelValue:j.value,"onUpdate:modelValue":e[9]||(e[9]=l=>j.value=l),placeholder:"多个关键词用逗号分隔"},null,8,["modelValue"]),e[29]||(e[29]=p("div",{class:"form-tip"},"用户回复包含这些关键词时继续执行",-1))]),_:1}),t(r,{label:"匹配模式"},{default:a(()=>[t(J,{modelValue:n.value.config.matchMode,"onUpdate:modelValue":e[10]||(e[10]=l=>n.value.config.matchMode=l),style:{width:"100%"}},{default:a(()=>[(f(),y(w,null,T(Z,l=>t(h,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})],64)):k("",!0),n.value.type==="delay"?(f(),y(w,{key:2},[t(r,{label:"延迟模式"},{default:a(()=>[t(J,{modelValue:n.value.config.delayMode,"onUpdate:modelValue":e[11]||(e[11]=l=>n.value.config.delayMode=l),style:{width:"100%"}},{default:a(()=>[(f(),y(w,null,T(Q,l=>t(h,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),n.value.config.delayMode==="fixed"?(f(),V(r,{key:0,label:"延迟时间"},{default:a(()=>[t($,{modelValue:n.value.config.delayMs,"onUpdate:modelValue":e[12]||(e[12]=l=>n.value.config.delayMs=l),min:0,step:1e3},null,8,["modelValue"]),e[30]||(e[30]=p("span",{class:"form-tip"},"毫秒",-1))]),_:1})):(f(),y(w,{key:1},[t(r,{label:"最小延迟"},{default:a(()=>[t($,{modelValue:n.value.config.delayMinMs,"onUpdate:modelValue":e[13]||(e[13]=l=>n.value.config.delayMinMs=l),min:0,step:1e3},null,8,["modelValue"]),e[31]||(e[31]=p("span",{class:"form-tip"},"毫秒",-1))]),_:1}),t(r,{label:"最大延迟"},{default:a(()=>[t($,{modelValue:n.value.config.delayMaxMs,"onUpdate:modelValue":e[14]||(e[14]=l=>n.value.config.delayMaxMs=l),min:0,step:1e3},null,8,["modelValue"]),e[32]||(e[32]=p("span",{class:"form-tip"},"毫秒",-1))]),_:1})],64))],64)):k("",!0),n.value.type==="notify"?(f(),V(r,{key:3,label:"通知消息"},{default:a(()=>[t(b,{modelValue:n.value.config.message,"onUpdate:modelValue":e[15]||(e[15]=l=>n.value.config.message=l),type:"textarea",rows:2,placeholder:"通知消息内容"},null,8,["modelValue"])]),_:1})):k("",!0),n.value.type==="condition"?(f(),V(r,{key:4,label:"条件表达式"},{default:a(()=>[t(b,{modelValue:n.value.config.expression,"onUpdate:modelValue":e[16]||(e[16]=l=>n.value.config.expression=l),placeholder:"条件表达式"},null,8,["modelValue"]),e[33]||(e[33]=p("div",{class:"form-tip"},"支持变量：orderStatus, orderAmount 等",-1))]),_:1})):k("",!0)]),_:1})]),_:1},8,["modelValue","title"])])}}}),xl=ke(il,[["__scopeId","data-v-3bf24e7f"]]);export{xl as default};
